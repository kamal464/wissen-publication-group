name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy-to-ec2:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Write SSH private key using printf to preserve exact formatting
          printf '%s\n' "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          # Remove any Windows line endings (CRLF -> LF)
          sed -i 's/\r$//' ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Verify key exists and has content
          if [ ! -s ~/.ssh/id_rsa ]; then
            echo "‚ùå SSH key file is empty"
            exit 1
          fi
          # Check key format
          if ! grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/id_rsa; then
            echo "‚ùå Invalid SSH key format"
            echo "First 3 lines of key file:"
            head -3 ~/.ssh/id_rsa
            exit 1
          fi
          echo "‚úÖ SSH key file created successfully"
          # Add EC2 host to known_hosts
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts
          echo "‚úÖ SSH setup complete"

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e
            echo "=========================================="
            echo "üöÄ STARTING DEPLOYMENT"
            echo "=========================================="
            echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo ""
            
            # Navigate to project directory
            cd /var/www/wissen-publication-group
            echo "üìÅ Current directory: $(pwd)"
            echo ""
            
            # Pull latest code
            echo "=========================================="
            echo "üì• STEP 1: PULLING LATEST CODE"
            echo "=========================================="
            echo "Previous commit: $(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')"
            
            # Kill PM2 processes FIRST to ensure they're not holding files
            echo "üõë Stopping PM2 processes before git pull..."
            pm2 delete all 2>/dev/null || true
            sleep 2
            
            git fetch origin
            echo "‚úÖ Fetched from origin"
            git reset --hard origin/main
            echo "‚úÖ Reset to origin/main"
            git clean -fd
            echo "‚úÖ Cleaned untracked files"
            
            # Show current commit to verify
            NEW_COMMIT=$(git rev-parse --short HEAD)
            COMMIT_MSG=$(git log -1 --pretty=%B)
            echo ""
            echo "üìå NEW COMMIT: $NEW_COMMIT"
            echo "üìå COMMIT MESSAGE: $COMMIT_MSG"
            echo "üìå COMMIT DATE: $(git log -1 --pretty=%cd)"
            echo ""
            
            # VERIFY: Check that Header.tsx actually has "Contact Us"
            echo "üîç VERIFYING: Checking Header.tsx for 'Contact Us'..."
            if grep -q "Contact Us" frontend/src/components/layout/Header.tsx; then
              echo "‚úÖ Header.tsx contains 'Contact Us'"
              grep -A 2 -B 2 "Contact Us" frontend/src/components/layout/Header.tsx | head -5
            else
              echo "‚ùå ERROR: Header.tsx does NOT contain 'Contact Us'!"
              echo "File content:"
              cat frontend/src/components/layout/Header.tsx | grep -A 5 "menuItems"
              exit 1
            fi
            echo ""
            
            # Update backend environment file
            echo "‚öôÔ∏è  Updating backend environment..."
            cat > backend/.env << ENVEOF
            DATABASE_URL=postgresql://postgres:${{ secrets.DB_PASSWORD }}@localhost:5432/wissen_publication_group
            NODE_ENV=production
            PORT=3001
            CORS_ORIGIN=http://${{ secrets.EC2_HOST }},http://${{ secrets.EC2_DOMAIN }},http://www.${{ secrets.EC2_DOMAIN }},http://localhost:3000,http://localhost:3002
            AWS_REGION=${{ secrets.AWS_REGION }}
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
            CLOUDFRONT_URL=${{ secrets.CLOUDFRONT_URL }}
            ENVEOF
            
            # Update frontend environment file
            echo "‚öôÔ∏è  Updating frontend environment..."
            echo "NEXT_PUBLIC_API_URL=http://${{ secrets.EC2_DOMAIN }}/api" > frontend/.env.production
            
            # Install backend dependencies
            echo "=========================================="
            echo "üì¶ STEP 2: BACKEND SETUP"
            echo "=========================================="
            cd backend
            echo "üìÅ Backend directory: $(pwd)"
            echo "Installing dependencies..."
            npm ci
            echo "‚úÖ Backend dependencies installed"
            
            # Generate Prisma Client
            echo "üîß Generating Prisma Client..."
            npx prisma generate
            
            # Run database migrations
            echo "üóÑÔ∏è  Running database migrations..."
            npx prisma db push --accept-data-loss || echo "‚ö†Ô∏è  Database push completed with warnings"
            
            # Clean backend build directory
            echo "üßπ Cleaning backend build..."
            rm -rf dist 2>/dev/null || true
            
            # Build backend
            echo ""
            echo "üî® Building backend..."
            npm run build
            if [ -f "dist/main.js" ]; then
              echo "‚úÖ Backend built successfully"
              echo "üì¶ Build file size: $(du -h dist/main.js | cut -f1)"
              echo "üìÖ Build time: $(date)"
            else
              echo "‚ùå ERROR: Backend build file not found!"
              exit 1
            fi
            echo ""
            
            # Install frontend dependencies
            echo "=========================================="
            echo "üì¶ STEP 3: FRONTEND SETUP"
            echo "=========================================="
            cd ../frontend
            echo "üìÅ Frontend directory: $(pwd)"
            echo "Installing dependencies..."
            npm ci
            echo "‚úÖ Frontend dependencies installed"
            
            # Clean Next.js cache before building
            echo "üßπ Cleaning Next.js cache..."
            rm -rf .next 2>/dev/null || true
            rm -rf node_modules/.cache 2>/dev/null || true
            rm -rf .swc 2>/dev/null || true
            rm -rf .next/cache 2>/dev/null || true
            rm -rf out 2>/dev/null || true
            # Also clear standalone if it exists
            rm -rf standalone 2>/dev/null || true
            echo "‚úÖ All caches cleared"
            
            # Verify cache is cleared
            if [ -d ".next" ]; then
              echo "‚ö†Ô∏è  WARNING: .next directory still exists after cleanup!"
              ls -la .next | head -10
            else
              echo "‚úÖ Verified: .next directory is completely removed"
            fi
            echo ""
            
            # Build frontend with deployment timestamp
            echo ""
            echo "üî® Building frontend..."
            export NEXT_PUBLIC_BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            echo "üìÖ Build timestamp: $NEXT_PUBLIC_BUILD_TIME"
            echo "üìÖ Setting NEXT_PUBLIC_BUILD_TIME=$NEXT_PUBLIC_BUILD_TIME"
            # Set it in .env.production as well for Next.js to pick up
            echo "NEXT_PUBLIC_BUILD_TIME=$NEXT_PUBLIC_BUILD_TIME" >> .env.production
            echo "üìã .env.production contents:"
            cat .env.production
            echo ""
            NEXT_PUBLIC_BUILD_TIME=$NEXT_PUBLIC_BUILD_TIME npm run build
            if [ -d ".next" ]; then
              echo "‚úÖ Frontend built successfully"
              echo "üì¶ Build directory size: $(du -sh .next | cut -f1)"
              echo "üìÖ Build time: $(date)"
            else
              echo "‚ùå ERROR: Frontend build directory not found!"
              exit 1
            fi
            echo ""
            
            # Restart services with PM2 (force restart to ensure changes are loaded)
            echo "=========================================="
            echo "üîÑ STEP 4: RESTARTING SERVICES"
            echo "=========================================="
            cd /var/www/wissen-publication-group
            echo "üìÅ Project root: $(pwd)"
            echo ""
            
            # Show PM2 status before restart
            echo "üìä PM2 Status BEFORE restart:"
            pm2 status || echo "PM2 not running"
            echo ""
            
            # Stop all PM2 processes first (don't kill daemon)
            echo "üõë Stopping all PM2 processes..."
            pm2 delete all 2>/dev/null || echo "No processes to delete"
            sleep 2
            
            # Ensure PM2 daemon is running
            echo "üîß Ensuring PM2 daemon is running..."
            if ! pm2 ping 2>/dev/null; then
              echo "‚ö†Ô∏è  PM2 daemon not responding, starting it..."
              pm2 kill 2>/dev/null || true
              sleep 2
            fi
            pm2 ping || echo "‚ö†Ô∏è  PM2 daemon check failed, but continuing..."
            sleep 1
            
            # Clear PM2 logs
            echo "üßπ Clearing PM2 logs..."
            pm2 flush 2>/dev/null || echo "No logs to clear"
            
            # Verify ecosystem.config.js exists and is readable
            echo "üìã Checking ecosystem.config.js..."
            if [ -f "ecosystem.config.js" ]; then
              echo "‚úÖ ecosystem.config.js found"
              cat ecosystem.config.js | head -20
            else
              echo "‚ùå ERROR: ecosystem.config.js not found!"
              exit 1
            fi
            echo ""
            
            # Start services fresh
            echo "üöÄ Starting services with PM2..."
            pm2 start ecosystem.config.js
            echo "‚úÖ PM2 start command executed"
            pm2 save
            echo "‚úÖ PM2 save executed"
            
            # Verify processes started
            echo "üîç Verifying processes started..."
            sleep 3
            PM2_LIST=$(pm2 list)
            echo "üìä PM2 List Output:"
            echo "$PM2_LIST"
            echo ""
            
            if ! echo "$PM2_LIST" | grep -q "wissen-backend"; then
              echo "‚ùå ERROR: wissen-backend not found in PM2!"
              echo "PM2 status:"
              pm2 status
              echo ""
              echo "PM2 logs:"
              pm2 logs --lines 30 --nostream
              exit 1
            fi
            
            if ! echo "$PM2_LIST" | grep -q "wissen-frontend"; then
              echo "‚ùå ERROR: wissen-frontend not found in PM2!"
              echo "PM2 status:"
              pm2 status
              echo ""
              echo "PM2 logs:"
              pm2 logs --lines 30 --nostream
              exit 1
            fi
            
            echo "‚úÖ Both processes found in PM2"
            
            # Check process status
            BACKEND_STATUS=$(pm2 jlist | jq -r '.[] | select(.name=="wissen-backend") | .pm2_env.status' 2>/dev/null || echo "unknown")
            FRONTEND_STATUS=$(pm2 jlist | jq -r '.[] | select(.name=="wissen-frontend") | .pm2_env.status' 2>/dev/null || echo "unknown")
            echo "  Backend status: $BACKEND_STATUS"
            echo "  Frontend status: $FRONTEND_STATUS"
            
            if [ "$BACKEND_STATUS" != "online" ]; then
              echo "‚ö†Ô∏è  WARNING: Backend status is '$BACKEND_STATUS', not 'online'"
              echo "Backend logs:"
              pm2 logs wissen-backend --lines 30 --nostream
            fi
            
            if [ "$FRONTEND_STATUS" != "online" ]; then
              echo "‚ö†Ô∏è  WARNING: Frontend status is '$FRONTEND_STATUS', not 'online'"
              echo "Frontend logs:"
              pm2 logs wissen-frontend --lines 30 --nostream
            fi
            echo ""
            
            # Wait for services to start and verify they're listening
            echo "‚è≥ Waiting for services to start (20 seconds)..."
            sleep 20
            
            # CRITICAL: Verify services are actually listening on ports
            echo "üîç Verifying services are listening on ports..."
            BACKEND_LISTENING=$(netstat -tln 2>/dev/null | grep -c ":3001 " || echo "0")
            FRONTEND_LISTENING=$(netstat -tln 2>/dev/null | grep -c ":3000 " || echo "0")
            
            if [ "$BACKEND_LISTENING" -eq "0" ]; then
              echo "‚ùå ERROR: Backend is NOT listening on port 3001!"
              echo "PM2 status:"
              pm2 status
              echo "Backend logs:"
              pm2 logs wissen-backend --lines 30 --nostream
              exit 1
            else
              echo "‚úÖ Backend is listening on port 3001"
            fi
            
            if [ "$FRONTEND_LISTENING" -eq "0" ]; then
              echo "‚ùå ERROR: Frontend is NOT listening on port 3000!"
              echo "PM2 status:"
              pm2 status
              echo "Frontend logs:"
              pm2 logs wissen-frontend --lines 30 --nostream
              exit 1
            else
              echo "‚úÖ Frontend is listening on port 3000"
            fi
            echo ""
            
            # VERIFY: Check that the running process is using the new code
            echo "üîç VERIFYING: Checking if running code matches deployment..."
            BACKEND_PID=$(pm2 pid wissen-backend 2>/dev/null || echo "")
            FRONTEND_PID=$(pm2 pid wissen-frontend 2>/dev/null || echo "")
            
            if [ -n "$BACKEND_PID" ]; then
              BACKEND_CWD=$(pwdx $BACKEND_PID 2>/dev/null | awk '{print $2}' || readlink -f /proc/$BACKEND_PID/cwd 2>/dev/null || echo "unknown")
              echo "  Backend PID: $BACKEND_PID"
              echo "  Backend CWD: $BACKEND_CWD"
            fi
            
            if [ -n "$FRONTEND_PID" ]; then
              FRONTEND_CWD=$(pwdx $FRONTEND_PID 2>/dev/null | awk '{print $2}' || readlink -f /proc/$FRONTEND_PID/cwd 2>/dev/null || echo "unknown")
              echo "  Frontend PID: $FRONTEND_PID"
              echo "  Frontend CWD: $FRONTEND_CWD"
              
              # Check if frontend is actually using the new .next directory
              if [ -d "frontend/.next" ]; then
                NEXT_BUILD_TIME=$(stat -c %Y frontend/.next/BUILD_ID 2>/dev/null || echo "0")
                CURRENT_TIME=$(date +%s)
                BUILD_AGE=$((CURRENT_TIME - NEXT_BUILD_TIME))
                echo "  Frontend .next build age: $BUILD_AGE seconds"
                if [ "$BUILD_AGE" -gt 600 ]; then
                  echo "  ‚ö†Ô∏è  WARNING: Frontend build is more than 10 minutes old!"
                fi
              fi
            fi
            echo ""
            
            # Show PM2 status
            echo ""
            echo "üìä PM2 Status AFTER restart:"
            pm2 status
            echo ""
            
            # Verify services are running with new code
            echo "=========================================="
            echo "üîç STEP 5: VERIFYING DEPLOYMENT"
            echo "=========================================="
            
            echo "Backend process details:"
            pm2 describe wissen-backend 2>/dev/null | grep -E "status|pid|uptime|restarts|pm2 env" || echo "‚ùå Backend not found in PM2"
            echo ""
            
            echo "Frontend process details:"
            pm2 describe wissen-frontend 2>/dev/null | grep -E "status|pid|uptime|restarts|pm2 env" || echo "‚ùå Frontend not found in PM2"
            echo ""
            
            # Test if services are responding
            echo "Testing backend health endpoint..."
            BACKEND_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/api/health || echo "000")
            if [ "$BACKEND_HEALTH" = "200" ]; then
              echo "‚úÖ Backend is responding (HTTP $BACKEND_HEALTH)"
              curl -s http://localhost:3001/api/health | head -3
            else
              echo "‚ùå Backend not responding (HTTP $BACKEND_HEALTH)"
            fi
            echo ""
            
            echo "Testing frontend..."
            FRONTEND_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 || echo "000")
            if [ "$FRONTEND_RESPONSE" = "200" ]; then
              echo "‚úÖ Frontend is responding (HTTP $FRONTEND_RESPONSE)"
              curl -s http://localhost:3000 | head -3
            else
              echo "‚ùå Frontend not responding (HTTP $FRONTEND_RESPONSE)"
            fi
            echo ""
            
            # Verify code is actually updated
            echo "Verifying deployed code matches GitHub..."
            DEPLOYED_COMMIT=$(git rev-parse --short HEAD)
            echo "üìå Deployed commit: $DEPLOYED_COMMIT"
            echo "üìå Full commit hash: $(git rev-parse HEAD)"
            echo ""
            
            # VERIFY AGAIN: Check Header.tsx one more time after build
            echo "üîç FINAL VERIFICATION: Checking Header.tsx after build..."
            if grep -q "Contact Us" frontend/src/components/layout/Header.tsx; then
              echo "‚úÖ Header.tsx still contains 'Contact Us' (source file verified)"
            else
              echo "‚ùå ERROR: Header.tsx lost 'Contact Us' after build!"
              exit 1
            fi
            
            # Check if the built .next contains the change
            if [ -f "frontend/.next/server/app/layout.js" ] || [ -f "frontend/.next/server/app/layout.js.map" ]; then
              echo "‚úÖ Frontend build files exist"
            else
              echo "‚ö†Ô∏è  Frontend build structure may be different (standalone mode)"
            fi
            echo ""
            
            # Verify build files are recent (within last 2 minutes)
            echo "üîç Verifying build files are recent..."
            BACKEND_BUILD_TIME=$(stat -c %Y backend/dist/main.js 2>/dev/null || echo "0")
            FRONTEND_BUILD_TIME=$(stat -c %Y frontend/.next/BUILD_ID 2>/dev/null || echo "0")
            CURRENT_TIME=$(date +%s)
            BACKEND_AGE=$((CURRENT_TIME - BACKEND_BUILD_TIME))
            FRONTEND_AGE=$((CURRENT_TIME - FRONTEND_BUILD_TIME))
            
            if [ "$BACKEND_AGE" -gt 300 ]; then
              echo "‚ö†Ô∏è  WARNING: Backend build is $BACKEND_AGE seconds old (may be stale)"
            else
              echo "‚úÖ Backend build is fresh ($BACKEND_AGE seconds old)"
            fi
            
            if [ "$FRONTEND_AGE" -gt 300 ]; then
              echo "‚ö†Ô∏è  WARNING: Frontend build is $FRONTEND_AGE seconds old (may be stale)"
            else
              echo "‚úÖ Frontend build is fresh ($FRONTEND_AGE seconds old)"
            fi
            echo ""
            
            # Check if PM2 is using the correct working directory
            echo "üîç Verifying PM2 working directories..."
            BACKEND_CWD=$(pm2 describe wissen-backend 2>/dev/null | grep "cwd" | awk '{print $2}' || echo "unknown")
            FRONTEND_CWD=$(pm2 describe wissen-frontend 2>/dev/null | grep "cwd" | awk '{print $2}' || echo "unknown")
            echo "  Backend CWD: $BACKEND_CWD"
            echo "  Frontend CWD: $FRONTEND_CWD"
            echo ""
            
            # Reload Nginx
            echo "=========================================="
            echo "üîÑ STEP 6: RELOADING NGINX"
            echo "=========================================="
            if sudo nginx -t; then
              echo "‚úÖ Nginx configuration is valid"
              sudo systemctl reload nginx
              echo "‚úÖ Nginx reloaded"
            else
              echo "‚ùå Nginx configuration test failed!"
              exit 1
            fi
            echo ""
            
            echo "=========================================="
            echo "‚úÖ DEPLOYMENT COMPLETE!"
            echo "=========================================="
            echo "üåê Application URL: http://${{ secrets.EC2_DOMAIN }}"
            echo "üìÖ Deployment timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "üìå Deployed commit: $DEPLOYED_COMMIT"
            echo "üìù Commit message: $COMMIT_MSG"
            echo ""
            echo "üîç Final verification:"
            echo "  - Backend status: $(pm2 jlist | grep -o '"name":"wissen-backend"[^}]*"status":"[^"]*' | grep -o '"status":"[^"]*' | cut -d'"' -f4 || echo 'unknown')"
            echo "  - Frontend status: $(pm2 jlist | grep -o '"name":"wissen-frontend"[^}]*"status":"[^"]*' | grep -o '"status":"[^"]*' | cut -d'"' -f4 || echo 'unknown')"
            echo "  - Backend uptime: $(pm2 describe wissen-backend 2>/dev/null | grep 'uptime' || echo 'N/A')"
            echo "  - Frontend uptime: $(pm2 describe wissen-frontend 2>/dev/null | grep 'uptime' || echo 'N/A')"
            echo ""
            
            # CRITICAL: Verify the actual HTML being served contains our changes
            echo "üîç CRITICAL: Verifying served HTML contains changes..."
            sleep 10
            
            # First check if frontend is responding at all
            FRONTEND_RESPONSE_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 2>/dev/null || echo "000")
            echo "Frontend response code: $FRONTEND_RESPONSE_CODE"
            
            if [ "$FRONTEND_RESPONSE_CODE" != "200" ]; then
              echo "‚ùå ERROR: Frontend is not responding (HTTP $FRONTEND_RESPONSE_CODE)"
              echo "PM2 status:"
              pm2 status
              echo ""
              echo "Frontend logs:"
              pm2 logs wissen-frontend --lines 50 --nostream
              echo ""
              echo "Checking if port 3000 is listening:"
              netstat -tln | grep ":3000" || echo "Port 3000 is NOT listening"
              exit 1
            fi
            
            FRONTEND_HTML=$(curl -s http://localhost:3000 2>/dev/null || echo "")
            if [ -z "$FRONTEND_HTML" ]; then
              echo "‚ùå ERROR: Frontend returned empty response!"
              echo "PM2 logs:"
              pm2 logs wissen-frontend --lines 50 --nostream
              exit 1
            fi
            
            if echo "$FRONTEND_HTML" | grep -q "Contact Us"; then
              echo "‚úÖ VERIFIED: Frontend HTML contains 'Contact Us'"
            else
              echo "‚ùå ERROR: Frontend HTML does NOT contain 'Contact Us'!"
              echo "This means the new code is NOT being served!"
              echo "Checking PM2 logs..."
              pm2 logs wissen-frontend --lines 50 --nostream
              echo ""
              echo "Checking if .next directory exists and has correct structure..."
              ls -la frontend/.next/ 2>/dev/null | head -20
              echo ""
              echo "First 200 characters of HTML response:"
              echo "$FRONTEND_HTML" | head -c 200
              exit 1
            fi
            
            if echo "$FRONTEND_HTML" | grep -q "AWS Deployed v2"; then
              echo "‚úÖ VERIFIED: Frontend HTML contains 'AWS Deployed v2'"
            else
              echo "‚ö†Ô∏è  WARNING: Frontend HTML does NOT contain 'AWS Deployed v2'"
            fi
            
            # Check Next.js build ID
            if [ -f "frontend/.next/BUILD_ID" ]; then
              BUILD_ID=$(cat frontend/.next/BUILD_ID)
              echo "üì¶ Next.js BUILD_ID: $BUILD_ID"
            fi
            
            echo ""
            echo "=========================================="
            
            # FINAL CHECK: Verify services are actually running before ending SSH session
            echo "üîç FINAL CHECK: Verifying services before ending deployment..."
            sleep 5
            
            PM2_FINAL_STATUS=$(pm2 status)
            echo "üìä Final PM2 Status:"
            echo "$PM2_FINAL_STATUS"
            echo ""
            
            # Check if services are online
            BACKEND_ONLINE=$(echo "$PM2_FINAL_STATUS" | grep "wissen-backend" | grep -q "online" && echo "yes" || echo "no")
            FRONTEND_ONLINE=$(echo "$PM2_FINAL_STATUS" | grep "wissen-frontend" | grep -q "online" && echo "yes" || echo "no")
            
            if [ "$BACKEND_ONLINE" = "no" ]; then
              echo "‚ùå CRITICAL: Backend is NOT online!"
              echo "Backend logs:"
              pm2 logs wissen-backend --lines 50 --nostream
            else
              echo "‚úÖ Backend is online"
            fi
            
            if [ "$FRONTEND_ONLINE" = "no" ]; then
              echo "‚ùå CRITICAL: Frontend is NOT online!"
              echo "Frontend logs:"
              pm2 logs wissen-frontend --lines 50 --nostream
            else
              echo "‚úÖ Frontend is online"
            fi
            
            # Test localhost endpoints
            echo ""
            echo "Testing localhost endpoints..."
            BACKEND_LOCAL=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/api/health 2>/dev/null || echo "000")
            FRONTEND_LOCAL=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 2>/dev/null || echo "000")
            
            echo "  Backend localhost:3001/api/health = HTTP $BACKEND_LOCAL"
            echo "  Frontend localhost:3000 = HTTP $FRONTEND_LOCAL"
            
            if [ "$BACKEND_LOCAL" != "200" ]; then
              echo "‚ö†Ô∏è  WARNING: Backend not responding on localhost"
            fi
            
            if [ "$FRONTEND_LOCAL" != "200" ]; then
              echo "‚ö†Ô∏è  WARNING: Frontend not responding on localhost"
            fi
            
            # Show port status
            echo ""
            echo "Port listening status:"
            netstat -tln 2>/dev/null | grep -E ":3000|:3001" || echo "No services listening on ports 3000 or 3001"
            
            echo ""
            echo "=========================================="
          ENDSSH

      - name: Verify deployment
        run: |
          echo "=========================================="
          echo "üîç FINAL VERIFICATION FROM GITHUB ACTIONS"
          echo "=========================================="
          echo "Waiting 30 seconds for services to fully start..."
          sleep 30
          
          EC2_HOST="${{ secrets.EC2_HOST }}"
          
          echo ""
          echo "Testing backend health endpoint..."
          BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://${EC2_HOST}/api/health" 2>&1 || echo "000")
          if [ "$BACKEND_STATUS" = "200" ]; then
            echo "‚úÖ Backend health check passed (HTTP $BACKEND_STATUS)"
            curl -s "http://${EC2_HOST}/api/health" 2>&1 | head -5
          else
            echo "‚ùå Backend health check failed (HTTP $BACKEND_STATUS)"
            echo "‚ö†Ô∏è  This might be normal if services are still starting"
            echo "‚ö†Ô∏è  Check the deployment logs above to see if services started correctly"
          fi
          echo ""
          
          echo "Testing frontend..."
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://${EC2_HOST}/" 2>&1 || echo "000")
          if [ "$FRONTEND_STATUS" = "200" ]; then
            echo "‚úÖ Frontend is accessible (HTTP $FRONTEND_STATUS)"
            echo ""
            echo "Checking if frontend HTML contains 'Contact Us'..."
            FRONTEND_HTML=$(curl -s "http://${EC2_HOST}/" 2>&1)
            if echo "$FRONTEND_HTML" | grep -q "Contact Us"; then
              echo "‚úÖ Frontend HTML contains 'Contact Us' - deployment successful!"
            else
              echo "‚ùå Frontend HTML does NOT contain 'Contact Us' - deployment may have failed"
              echo "First 100 lines of HTML:"
              echo "$FRONTEND_HTML" | head -100
            fi
            echo ""
            echo "Checking if frontend HTML contains 'AWS Deployed v2'..."
            if echo "$FRONTEND_HTML" | grep -q "AWS Deployed v2"; then
              echo "‚úÖ Frontend HTML contains 'AWS Deployed v2' - deployment badge is present!"
            else
              echo "‚ö†Ô∏è  Frontend HTML does NOT contain 'AWS Deployed v2' - badge may not be showing"
            fi
          else
            echo "‚ùå Frontend check failed (HTTP $FRONTEND_STATUS)"
            echo "‚ö†Ô∏è  This might be normal if services are still starting"
            echo "‚ö†Ô∏è  Check the deployment logs above to see if services started correctly"
          fi
          echo ""
          echo "=========================================="
          echo "üí° TIP: If health checks failed, wait 1-2 minutes and try accessing"
          echo "   http://${EC2_HOST}/ in your browser"
          echo "=========================================="

