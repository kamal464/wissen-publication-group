name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy-to-ec2:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Write SSH private key using printf to preserve exact formatting
          printf '%s\n' "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          # Remove any Windows line endings (CRLF -> LF)
          sed -i 's/\r$//' ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Verify key exists and has content
          if [ ! -s ~/.ssh/id_rsa ]; then
            echo "‚ùå SSH key file is empty"
            exit 1
          fi
          # Check key format
          if ! grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/id_rsa; then
            echo "‚ùå Invalid SSH key format"
            echo "First 3 lines of key file:"
            head -3 ~/.ssh/id_rsa
            exit 1
          fi
          echo "‚úÖ SSH key file created successfully"
          # Add EC2 host to known_hosts
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts
          echo "‚úÖ SSH setup complete"

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e
            echo "=========================================="
            echo "üöÄ STARTING DEPLOYMENT"
            echo "=========================================="
            echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo ""
            
            # Navigate to project directory
            cd /var/www/wissen-publication-group
            echo "üìÅ Current directory: $(pwd)"
            echo ""
            
            # Pull latest code
            echo "=========================================="
            echo "üì• STEP 1: PULLING LATEST CODE"
            echo "=========================================="
            echo "Previous commit: $(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')"
            git fetch origin
            echo "‚úÖ Fetched from origin"
            git reset --hard origin/main
            echo "‚úÖ Reset to origin/main"
            git clean -fd
            echo "‚úÖ Cleaned untracked files"
            # Show current commit to verify
            NEW_COMMIT=$(git rev-parse --short HEAD)
            COMMIT_MSG=$(git log -1 --pretty=%B)
            echo ""
            echo "üìå NEW COMMIT: $NEW_COMMIT"
            echo "üìå COMMIT MESSAGE: $COMMIT_MSG"
            echo "üìå COMMIT DATE: $(git log -1 --pretty=%cd)"
            echo ""
            
            # Update backend environment file
            echo "‚öôÔ∏è  Updating backend environment..."
            cat > backend/.env << ENVEOF
            DATABASE_URL=postgresql://postgres:${{ secrets.DB_PASSWORD }}@localhost:5432/wissen_publication_group
            NODE_ENV=production
            PORT=3001
            CORS_ORIGIN=http://${{ secrets.EC2_HOST }},http://${{ secrets.EC2_DOMAIN }},http://www.${{ secrets.EC2_DOMAIN }},http://localhost:3000,http://localhost:3002
            AWS_REGION=${{ secrets.AWS_REGION }}
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
            CLOUDFRONT_URL=${{ secrets.CLOUDFRONT_URL }}
            ENVEOF
            
            # Update frontend environment file
            echo "‚öôÔ∏è  Updating frontend environment..."
            echo "NEXT_PUBLIC_API_URL=http://${{ secrets.EC2_DOMAIN }}/api" > frontend/.env.production
            
            # Install backend dependencies
            echo "=========================================="
            echo "üì¶ STEP 2: BACKEND SETUP"
            echo "=========================================="
            cd backend
            echo "üìÅ Backend directory: $(pwd)"
            echo "Installing dependencies..."
            npm ci
            echo "‚úÖ Backend dependencies installed"
            
            # Generate Prisma Client
            echo "üîß Generating Prisma Client..."
            npx prisma generate
            
            # Run database migrations
            echo "üóÑÔ∏è  Running database migrations..."
            npx prisma db push --accept-data-loss || echo "‚ö†Ô∏è  Database push completed with warnings"
            
            # Clean backend build directory
            echo "üßπ Cleaning backend build..."
            rm -rf dist 2>/dev/null || true
            
            # Build backend
            echo ""
            echo "üî® Building backend..."
            npm run build
            if [ -f "dist/main.js" ]; then
              echo "‚úÖ Backend built successfully"
              echo "üì¶ Build file size: $(du -h dist/main.js | cut -f1)"
              echo "üìÖ Build time: $(date)"
            else
              echo "‚ùå ERROR: Backend build file not found!"
              exit 1
            fi
            echo ""
            
            # Install frontend dependencies
            echo "=========================================="
            echo "üì¶ STEP 3: FRONTEND SETUP"
            echo "=========================================="
            cd ../frontend
            echo "üìÅ Frontend directory: $(pwd)"
            echo "Installing dependencies..."
            npm ci
            echo "‚úÖ Frontend dependencies installed"
            
            # Clean Next.js cache before building
            echo "üßπ Cleaning Next.js cache..."
            rm -rf .next 2>/dev/null || true
            rm -rf node_modules/.cache 2>/dev/null || true
            rm -rf .swc 2>/dev/null || true
            echo "‚úÖ Cache cleared"
            
            # Build frontend with deployment timestamp
            echo ""
            echo "üî® Building frontend..."
            export NEXT_PUBLIC_BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            echo "üìÖ Build timestamp: $NEXT_PUBLIC_BUILD_TIME"
            NEXT_PUBLIC_BUILD_TIME=$NEXT_PUBLIC_BUILD_TIME npm run build
            if [ -d ".next" ]; then
              echo "‚úÖ Frontend built successfully"
              echo "üì¶ Build directory size: $(du -sh .next | cut -f1)"
              echo "üìÖ Build time: $(date)"
            else
              echo "‚ùå ERROR: Frontend build directory not found!"
              exit 1
            fi
            echo ""
            
            # Restart services with PM2 (force restart to ensure changes are loaded)
            echo "=========================================="
            echo "üîÑ STEP 4: RESTARTING SERVICES"
            echo "=========================================="
            cd /var/www/wissen-publication-group
            echo "üìÅ Project root: $(pwd)"
            echo ""
            
            # Show PM2 status before restart
            echo "üìä PM2 Status BEFORE restart:"
            pm2 status || echo "PM2 not running"
            echo ""
            
            # Stop all processes first
            echo "üõë Stopping all PM2 processes..."
            pm2 delete all 2>/dev/null || echo "No processes to delete"
            sleep 3
            
            # Clear PM2 logs
            echo "üßπ Clearing PM2 logs..."
            pm2 flush 2>/dev/null || echo "No logs to clear"
            
            # Verify ecosystem.config.js exists and is readable
            echo "üìã Checking ecosystem.config.js..."
            if [ -f "ecosystem.config.js" ]; then
              echo "‚úÖ ecosystem.config.js found"
              cat ecosystem.config.js | head -20
            else
              echo "‚ùå ERROR: ecosystem.config.js not found!"
              exit 1
            fi
            echo ""
            
            # Start services fresh
            echo "üöÄ Starting services with PM2..."
            pm2 start ecosystem.config.js
            echo "‚úÖ PM2 start command executed"
            pm2 save
            echo "‚úÖ PM2 save executed"
            
            # Verify processes started
            echo "üîç Verifying processes started..."
            sleep 2
            if ! pm2 list | grep -q "wissen-backend"; then
              echo "‚ùå ERROR: wissen-backend not found in PM2!"
              pm2 logs --lines 20
              exit 1
            fi
            if ! pm2 list | grep -q "wissen-frontend"; then
              echo "‚ùå ERROR: wissen-frontend not found in PM2!"
              pm2 logs --lines 20
              exit 1
            fi
            echo "‚úÖ Both processes found in PM2"
            
            # Wait for services to start
            echo "‚è≥ Waiting for services to start (10 seconds)..."
            sleep 10
            
            # Show PM2 status
            echo ""
            echo "üìä PM2 Status AFTER restart:"
            pm2 status
            echo ""
            
            # Verify services are running with new code
            echo "=========================================="
            echo "üîç STEP 5: VERIFYING DEPLOYMENT"
            echo "=========================================="
            
            echo "Backend process details:"
            pm2 describe wissen-backend 2>/dev/null | grep -E "status|pid|uptime|restarts|pm2 env" || echo "‚ùå Backend not found in PM2"
            echo ""
            
            echo "Frontend process details:"
            pm2 describe wissen-frontend 2>/dev/null | grep -E "status|pid|uptime|restarts|pm2 env" || echo "‚ùå Frontend not found in PM2"
            echo ""
            
            # Test if services are responding
            echo "Testing backend health endpoint..."
            BACKEND_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/api/health || echo "000")
            if [ "$BACKEND_HEALTH" = "200" ]; then
              echo "‚úÖ Backend is responding (HTTP $BACKEND_HEALTH)"
              curl -s http://localhost:3001/api/health | head -3
            else
              echo "‚ùå Backend not responding (HTTP $BACKEND_HEALTH)"
            fi
            echo ""
            
            echo "Testing frontend..."
            FRONTEND_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 || echo "000")
            if [ "$FRONTEND_RESPONSE" = "200" ]; then
              echo "‚úÖ Frontend is responding (HTTP $FRONTEND_RESPONSE)"
              curl -s http://localhost:3000 | head -3
            else
              echo "‚ùå Frontend not responding (HTTP $FRONTEND_RESPONSE)"
            fi
            echo ""
            
            # Verify code is actually updated
            echo "Verifying deployed code matches GitHub..."
            DEPLOYED_COMMIT=$(git rev-parse --short HEAD)
            echo "üìå Deployed commit: $DEPLOYED_COMMIT"
            echo "üìå Full commit hash: $(git rev-parse HEAD)"
            echo ""
            
            # Verify build files are recent (within last 2 minutes)
            echo "üîç Verifying build files are recent..."
            BACKEND_BUILD_TIME=$(stat -c %Y backend/dist/main.js 2>/dev/null || echo "0")
            FRONTEND_BUILD_TIME=$(stat -c %Y frontend/.next/BUILD_ID 2>/dev/null || echo "0")
            CURRENT_TIME=$(date +%s)
            BACKEND_AGE=$((CURRENT_TIME - BACKEND_BUILD_TIME))
            FRONTEND_AGE=$((CURRENT_TIME - FRONTEND_BUILD_TIME))
            
            if [ "$BACKEND_AGE" -gt 300 ]; then
              echo "‚ö†Ô∏è  WARNING: Backend build is $BACKEND_AGE seconds old (may be stale)"
            else
              echo "‚úÖ Backend build is fresh ($BACKEND_AGE seconds old)"
            fi
            
            if [ "$FRONTEND_AGE" -gt 300 ]; then
              echo "‚ö†Ô∏è  WARNING: Frontend build is $FRONTEND_AGE seconds old (may be stale)"
            else
              echo "‚úÖ Frontend build is fresh ($FRONTEND_AGE seconds old)"
            fi
            echo ""
            
            # Check if PM2 is using the correct working directory
            echo "üîç Verifying PM2 working directories..."
            BACKEND_CWD=$(pm2 describe wissen-backend 2>/dev/null | grep "cwd" | awk '{print $2}' || echo "unknown")
            FRONTEND_CWD=$(pm2 describe wissen-frontend 2>/dev/null | grep "cwd" | awk '{print $2}' || echo "unknown")
            echo "  Backend CWD: $BACKEND_CWD"
            echo "  Frontend CWD: $FRONTEND_CWD"
            echo ""
            
            # Reload Nginx
            echo "=========================================="
            echo "üîÑ STEP 6: RELOADING NGINX"
            echo "=========================================="
            if sudo nginx -t; then
              echo "‚úÖ Nginx configuration is valid"
              sudo systemctl reload nginx
              echo "‚úÖ Nginx reloaded"
            else
              echo "‚ùå Nginx configuration test failed!"
              exit 1
            fi
            echo ""
            
            echo "=========================================="
            echo "‚úÖ DEPLOYMENT COMPLETE!"
            echo "=========================================="
            echo "üåê Application URL: http://${{ secrets.EC2_DOMAIN }}"
            echo "üìÖ Deployment timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "üìå Deployed commit: $DEPLOYED_COMMIT"
            echo "üìù Commit message: $COMMIT_MSG"
            echo ""
            echo "üîç Final verification:"
            echo "  - Backend status: $(pm2 jlist | grep -o '"name":"wissen-backend"[^}]*"status":"[^"]*' | grep -o '"status":"[^"]*' | cut -d'"' -f4 || echo 'unknown')"
            echo "  - Frontend status: $(pm2 jlist | grep -o '"name":"wissen-frontend"[^}]*"status":"[^"]*' | grep -o '"status":"[^"]*' | cut -d'"' -f4 || echo 'unknown')"
            echo "  - Backend uptime: $(pm2 describe wissen-backend 2>/dev/null | grep 'uptime' || echo 'N/A')"
            echo "  - Frontend uptime: $(pm2 describe wissen-frontend 2>/dev/null | grep 'uptime' || echo 'N/A')"
            echo ""
            echo "=========================================="
          ENDSSH

      - name: Verify deployment
        run: |
          echo "=========================================="
          echo "üîç FINAL VERIFICATION"
          echo "=========================================="
          sleep 15
          echo "Testing backend health endpoint..."
          BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.EC2_HOST }}/api/health || echo "000")
          if [ "$BACKEND_STATUS" = "200" ]; then
            echo "‚úÖ Backend health check passed (HTTP $BACKEND_STATUS)"
            curl -s http://${{ secrets.EC2_HOST }}/api/health | head -5
          else
            echo "‚ùå Backend health check failed (HTTP $BACKEND_STATUS)"
            echo "‚ö†Ô∏è  Deployment may still be in progress or there may be an issue"
          fi
          echo ""
          echo "Testing frontend..."
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.EC2_HOST }}/ || echo "000")
          if [ "$FRONTEND_STATUS" = "200" ]; then
            echo "‚úÖ Frontend is accessible (HTTP $FRONTEND_STATUS)"
          else
            echo "‚ùå Frontend check failed (HTTP $FRONTEND_STATUS)"
          fi
          echo ""
          echo "=========================================="

