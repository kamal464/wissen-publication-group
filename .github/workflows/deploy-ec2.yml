name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy-to-ec2:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Write SSH private key using printf to preserve exact formatting
          printf '%s\n' "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          # Remove any Windows line endings (CRLF -> LF)
          sed -i 's/\r$//' ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Verify key exists and has content
          if [ ! -s ~/.ssh/id_rsa ]; then
            echo "‚ùå SSH key file is empty"
            exit 1
          fi
          # Check key format
          if ! grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/id_rsa; then
            echo "‚ùå Invalid SSH key format"
            echo "First 3 lines of key file:"
            head -3 ~/.ssh/id_rsa
            exit 1
          fi
          echo "‚úÖ SSH key file created successfully"
          # Add EC2 host to known_hosts
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts
          echo "‚úÖ SSH setup complete"

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e
            echo "üöÄ Starting deployment..."
            
            # Navigate to project directory
            cd /var/www/wissen-publication-group
            
            # Pull latest code
            echo "üì• Pulling latest code..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            # Show current commit to verify
            echo "üìå Current commit: $(git rev-parse --short HEAD)"
            echo "üìå Commit message: $(git log -1 --pretty=%B)"
            
            # Update backend environment file
            echo "‚öôÔ∏è  Updating backend environment..."
            cat > backend/.env << ENVEOF
            DATABASE_URL=postgresql://postgres:${{ secrets.DB_PASSWORD }}@localhost:5432/wissen_publication_group
            NODE_ENV=production
            PORT=3001
            CORS_ORIGIN=http://${{ secrets.EC2_HOST }},http://${{ secrets.EC2_DOMAIN }},http://www.${{ secrets.EC2_DOMAIN }},http://localhost:3000,http://localhost:3002
            AWS_REGION=${{ secrets.AWS_REGION }}
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
            CLOUDFRONT_URL=${{ secrets.CLOUDFRONT_URL }}
            ENVEOF
            
            # Update frontend environment file
            echo "‚öôÔ∏è  Updating frontend environment..."
            echo "NEXT_PUBLIC_API_URL=http://${{ secrets.EC2_DOMAIN }}/api" > frontend/.env.production
            
            # Install backend dependencies
            echo "üì¶ Installing backend dependencies..."
            cd backend
            npm ci
            
            # Generate Prisma Client
            echo "üîß Generating Prisma Client..."
            npx prisma generate
            
            # Run database migrations
            echo "üóÑÔ∏è  Running database migrations..."
            npx prisma db push --accept-data-loss || echo "‚ö†Ô∏è  Database push completed with warnings"
            
            # Clean backend build directory
            echo "üßπ Cleaning backend build..."
            rm -rf dist 2>/dev/null || true
            
            # Build backend
            echo "üî® Building backend..."
            npm run build
            echo "‚úÖ Backend built successfully"
            
            # Install frontend dependencies
            echo "üì¶ Installing frontend dependencies..."
            cd ../frontend
            npm ci
            
            # Clean Next.js cache before building
            echo "üßπ Cleaning Next.js cache..."
            rm -rf .next 2>/dev/null || true
            
            # Build frontend with deployment timestamp
            echo "üî® Building frontend..."
            export NEXT_PUBLIC_BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            echo "üìÖ Build timestamp: $NEXT_PUBLIC_BUILD_TIME"
            NEXT_PUBLIC_BUILD_TIME=$NEXT_PUBLIC_BUILD_TIME npm run build
            echo "‚úÖ Frontend built successfully"
            
            # Restart services with PM2 (force restart to ensure changes are loaded)
            echo "üîÑ Restarting services..."
            cd /var/www/wissen-publication-group
            # Stop all processes first
            pm2 delete all 2>/dev/null || true
            # Clear PM2 logs
            pm2 flush 2>/dev/null || true
            # Start services fresh
            pm2 start ecosystem.config.js
            pm2 save
            # Wait a moment for services to start
            sleep 5
            # Show PM2 status
            pm2 status
            echo "‚úÖ Services restarted"
            
            # Reload Nginx
            echo "üîÑ Reloading Nginx..."
            sudo nginx -t && sudo systemctl reload nginx
            
            echo "‚úÖ Deployment complete!"
            echo "üåê Application is live at: http://${{ secrets.EC2_DOMAIN }}"
          ENDSSH

      - name: Verify deployment
        run: |
          sleep 10
          curl -f http://${{ secrets.EC2_HOST }}/api/health || echo "‚ö†Ô∏è  Health check failed, but deployment may still be in progress"

